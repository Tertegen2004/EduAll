@using EduAll.ViewModel
@model MyCourses_vm

@{
    ViewData["Title"] = "My Courses";
}

<style>
    .course-image-fixed-height {
        height: 240px;
        width: 100%;
    }

        .course-image-fixed-height img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    /* لون البار المكتمل */
    .bg-success-custom {
        background-color: #27CFA7 !important;
    }
</style>
<section class="breadcrumb py-120 bg-main-25 position-relative z-1 overflow-hidden mb-0">
    <img src="/assets/images/shapes/shape1.png" alt="" class="shape one animation-rotation d-md-block d-none" />
    <div class="container">
        <div class="row justify-content-center">
            <partial name="_Notification" />

            <div class="col-lg-8">
                <div class="breadcrumb__wrapper">
                    <h1 class="breadcrumb__title display-4 fw-semibold text-center">My Learning</h1>
                    <ul class="breadcrumb__list d-flex align-items-center justify-content-center gap-4">
                        <li class="breadcrumb__item">
                            <a asp-controller="Home" asp-action="Index" class="breadcrumb__link text-neutral-500 hover-text-main-600 fw-medium">Home</a>
                        </li>
                        <li class="breadcrumb__item"><i class="text-neutral-500 d-flex ph-bold ph-caret-right"></i></li>
                        <li class="breadcrumb__item"><span class="text-main-two-600">My Courses</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="course-grid-view py-120">
    <div class="container">

        <div class="d-flex justify-content-center mb-40">
            <div class="nav-tab-wrapper bg-white p-16 d-inline-block rounded-pill box-shadow-sm">
                <ul class="nav nav-pills common-tab gap-16" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link rounded-pill bg-main-25 text-md fw-medium text-neutral-500 flex-center gap-8 active"
                                id="pills-onGoing-tab" data-bs-toggle="pill" data-bs-target="#pills-onGoing" type="button">
                            <i class="ph-bold ph-play-circle text-xl"></i> Ongoing (@Model.OngoingCourses.Count)
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link rounded-pill bg-main-25 text-md fw-medium text-neutral-500 flex-center gap-8"
                                id="pills-completed-tab" data-bs-toggle="pill" data-bs-target="#pills-completed" type="button">
                            <i class="ph-bold ph-check-circle text-xl"></i> Completed (@Model.CompletedCourses.Count)
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="pills-tabContent">

            <div class="tab-pane fade show active" id="pills-onGoing">
                <div class="row gy-4">
                    @if (Model.OngoingCourses.Any())
                    {
                        @foreach (var item in Model.OngoingCourses)
                        {
                            <div class="col-lg-4 col-sm-6 wow fadeInUp" data-aos="fade-up" data-aos-duration="200">
                                <div class="course-item bg-white rounded-16 p-12 h-100 box-shadow-md border border-neutral-30 hover-border-main-600 transition-2">

                                    <div class="course-item__thumb rounded-12 overflow-hidden position-relative course-image-fixed-height">
                                        <a asp-controller="Course" asp-action="Watch" asp-route-id="@item.Id" class="w-100 h-100 d-block">
                                            <img src="@(string.IsNullOrEmpty(item.ImgUrl) ? "/assets/images/thumbs/course-img1.png" : item.ImgUrl)" alt="@item.Title" class="course-item__img rounded-12 cover-img transition-2">
                                        </a>
                                        <div class="flex-align gap-8 bg-main-600 rounded-pill px-24 py-12 text-white position-absolute inset-block-start-0 inset-inline-start-0 mt-20 ms-20 z-1">
                                            <span class="text-2xl d-flex"><i class="ph ph-clock"></i></span>
                                            <span class="text-lg fw-medium">@item.Duration H</span>
                                        </div>
                                    </div>

                                    <div class="course-item__content pt-24">
                                        <div class="mb-16 flex-align gap-16 flex-wrap">
                                            <span class="py-4 px-12 rounded-pill text-main-600 fw-medium bg-main-25 text-sm">@item.Category</span>
                                            <span class="py-4 px-12 rounded-pill text-main-three-600 fw-medium bg-main-three-25 text-sm">@item.Level</span>
                                        </div>

                                        <h4 class="mb-16">
                                            <a asp-controller="Course" asp-action="Watch" asp-route-id="@item.Id" class="link text-line-2">@item.Title</a>
                                        </h4>

                                        <div class="mb-20">
                                            <div class="flex-between mb-8">
                                                <span class="text-neutral-500 text-sm fw-medium">Progress</span>
                                                <span class="text-main-600 text-sm fw-bold">@item.Progress%</span>
                                            </div>
                                            <div class="progress h-8 bg-main-50 rounded-pill">
                                                <div class="progress-bar bg-main-600 rounded-pill" role="progressbar" style="width: @item.Progress%" aria-valuenow="@item.Progress" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>

                                        <div class="flex-align gap-12 mt-20">
                                            <div class="flex-align gap-8">
                                                <img src="@(string.IsNullOrEmpty(item.InstructorImg) ? "/assets/images/thumbs/user-img1.png" : item.InstructorImg)" alt="" class="w-40 h-40 object-fit-cover rounded-circle border border-white box-shadow-sm">
                                                <div>
                                                    <span class="text-neutral-500 text-sm d-block">Instructor</span>
                                                    <span class="text-neutral-700 text-md fw-medium">@item.InstructorName</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-24">
                                            <a asp-controller="Course" asp-action="Watch" asp-route-id="@item.Id" class="btn btn-outline-main rounded-pill w-100 flex-center gap-8 fw-bold">
                                                Continue Learning <i class="ph-bold ph-play-circle text-xl"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12 text-center py-5">
                            <h5 class="text-neutral-500">No ongoing courses.</h5>
                            <a asp-controller="Course" asp-action="Index" class="btn btn-main rounded-pill mt-3">Explore Courses</a>
                        </div>
                    }
                </div>
            </div>

            <div class="tab-pane fade" id="pills-completed">
                <div class="row gy-4">
                    @if (Model.CompletedCourses.Any())
                    {
                        @foreach (var item in Model.CompletedCourses)
                        {
                            <div class="col-lg-4 col-sm-6 wow fadeInUp" data-aos="fade-up" data-aos-duration="200">
                                <div class="course-item bg-white rounded-16 p-12 h-100 box-shadow-md border border-neutral-30 hover-border-main-600 transition-2">
                                    <div class="course-item__thumb rounded-12 overflow-hidden position-relative course-image-fixed-height">
                                        <a asp-controller="Course" asp-action="Watch" asp-route-id="@item.Id" class="w-100 h-100 d-block">
                                            <img src="@(string.IsNullOrEmpty(item.ImgUrl) ? "/assets/images/thumbs/course-img1.png" : item.ImgUrl)" alt="@item.Title" class="course-item__img rounded-12 cover-img transition-2">
                                        </a>
                                        <div class="flex-align gap-8 bg-success-600 rounded-pill px-24 py-12 text-white position-absolute inset-block-start-0 inset-inline-start-0 mt-20 ms-20 z-1">
                                            <span class="text-2xl d-flex"><i class="ph ph-check-circle"></i></span>
                                            <span class="text-lg fw-medium">Completed</span>
                                        </div>
                                    </div>

                                    <div class="course-item__content pt-24">
                                        <div class="mb-16 flex-align gap-16 flex-wrap">
                                            <span class="py-4 px-12 rounded-pill text-main-600 fw-medium bg-main-25 text-sm">@item.Category</span>
                                        </div>
                                        <h4 class="mb-16">
                                            <a asp-controller="Course" asp-action="Watch" asp-route-id="@item.Id" class="link text-line-2">@item.Title</a>
                                        </h4>
                                        <div class="mb-20">
                                            <div class="flex-between mb-8">
                                                <span class="text-neutral-500 text-sm fw-medium">Progress</span>
                                                <span class="text-success-600 text-sm fw-bold">100%</span>
                                            </div>
                                            <div class="progress h-8 bg-main-50 rounded-pill">
                                                <div class="progress-bar bg-success-600 rounded-pill" role="progressbar" style="width: 100%"></div>
                                            </div>
                                        </div>
                                        <div class="mt-24">
                                            <a asp-controller="Course" asp-action="Watch" asp-route-id="@item.Id" class="btn btn-outline-main rounded-pill w-100 flex-center gap-8 fw-bold">
                                                Review Course <i class="ph-bold ph-star"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12 text-center py-5">
                            <h5 class="text-neutral-500">No completed courses yet.</h5>
                        </div>
                    }
                </div>
            </div>

            <div class="tab-pane fade" id="pills-favourite">
                <div class="row gy-4">
                    @if (Model.WishlistCourses.Any())
                    {
                        @foreach (var item in Model.WishlistCourses)
                        {
                            <div class="col-lg-4 col-sm-6 wow fadeInUp" data-aos="fade-up" data-aos-duration="200">
                                <div class="course-item bg-white rounded-16 p-12 h-100 box-shadow-md border border-neutral-30 hover-border-main-600 transition-2">
                                    <div class="course-item__thumb rounded-12 overflow-hidden position-relative course-image-fixed-height">
                                        <a asp-controller="Course" asp-action="Details" asp-route-id="@item.Id" class="w-100 h-100 d-block">
                                            <img src="@(string.IsNullOrEmpty(item.ImgUrl) ? "/assets/images/thumbs/course-img1.png" : item.ImgUrl)" alt="@item.Title" class="course-item__img rounded-12 cover-img transition-2">
                                        </a>
                                        <button type="button" onclick="toggleWishlist(@item.Id, this)" class="wishlist-btn w-48 h-48 flex-center position-absolute inset-block-start-0 inset-inline-end-0 mt-20 me-20 z-1 text-2xl rounded-circle transition-2 bg-main-50 text-main-two-600">
                                            <i class="ph-fill ph-heart"></i>
                                        </button>
                                    </div>
                                    <div class="course-item__content pt-24">
                                        <div class="mb-16 flex-align gap-16 flex-wrap">
                                            <span class="py-4 px-12 rounded-pill text-main-600 fw-medium bg-main-25 text-sm">@item.Category</span>
                                        </div>
                                        <h4 class="mb-16">
                                            <a asp-controller="Course" asp-action="Details" asp-route-id="@item.Id" class="link text-line-2">@item.Title</a>
                                        </h4>
                                        <div class="flex-between gap-8 pt-24 border-top border-neutral-50 mt-28 border-dashed border-0">
                                            <h4 class="mb-0 text-main-two-600">$@item.Price</h4>
                                            <button type="button" onclick="addToCart(@item.Id, this)" class="flex-align gap-8 text-main-600 hover-text-decoration-underline transition-1 fw-semibold bg-transparent border-0 p-0">
                                                Add To Cart <i class="ph ph-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12 text-center py-5">
                            <h5 class="text-neutral-500">Your wishlist is empty.</h5>
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>
</section>

@section Scripts {
    <script>

        function toggleWishlist(courseId, btnElement) {
            $.ajax({
                url: '/Wishlist/Toggle',
                type: 'POST',
                data: { courseId: courseId },
                success: function (response) {
                    if (response.success) {
                        var icon = $(btnElement).find('i');

                        // 1. الإمساك بعنصر العداد (اللي في الهيدر)
                        var countBadge = $("#wishlist-count");
                        var currentCount = parseInt(countBadge.text()); // قراءة الرقم الحالي

                        if (response.isAdded) {
                            // === حالة الإضافة ===
                            $(btnElement).addClass('bg-main-50 text-main-two-600').removeClass('bg-white text-neutral-500');
                            icon.removeClass('ph ph-bold').addClass('ph-fill');

                            // زيادة العداد
                            countBadge.text(currentCount + 1);

                            // (اختياري) تأثير انيميشن بسيط للعداد
                            countBadge.addClass("animate__bounceIn").one("animationend", function () {
                                $(this).removeClass("animate__bounceIn");
                            });

                        } else {
                            // === حالة الحذف ===
                            $(btnElement).removeClass('bg-main-50 text-main-two-600').addClass('bg-white text-neutral-500');
                            icon.removeClass('ph-fill').addClass('ph-bold');

                            // تنقيص العداد
                            if (currentCount > 0) countBadge.text(currentCount - 1);
                        }
                    } else {
                        window.location.href = '/Admin/Account/SignIn';
                    }
                },
                error: function () {
                    // handle error
                }
            });
        }
        function addToCart(courseId, btnElement) {
            // نغير النص لـ "Adding..." عشان اليوزر يعرف إن فيه حاجة بتحصل
            var originalText = $(btnElement).html();
            $(btnElement).html('<i class="ph ph-spinner ph-spin"></i> Adding...');

            $.ajax({
                url: '/Cart/Add',
                type: 'POST',
                data: { courseId: courseId },
                success: function (response) {
                    if (response.success) {
                        // 1. تحديث العداد في الهيدر
                        $('#cart-count-badge').text(response.cartCount);

                        // 2. تغيير شكل الزرار ليدل على النجاح
                        $(btnElement).html('Added <i class="ph-bold ph-check"></i>');
                        $(btnElement).addClass('text-success-600 cursor-default').attr('onclick', ''); // نلغي الضغط تاني

                        // (اختياري) رسالة توستر
                        // toastr.success(response.message);
                    } else {
                        // لو فشل (مثلاً موجود قبل كدا)
                        if (response.message === "Login required") {
                            window.location.href = '/Admin/Account/SignIn';
                        } else {
                            // نرجع الزرار زي ما كان ونطلع رسالة
                            $(btnElement).html(originalText);
                            alert(response.message); // أو toastr.warning
                        }
                    }
                },
                error: function () {
                    $(btnElement).html(originalText);
                    alert("Something went wrong");
                }
            });
        }
        $(document).ready(function () {

            // 1. الظهور: fadeIn بتظهر العنصر المخفي بنعومة
            $(".alert").fadeIn(600);

            // 2. الاختفاء: بعد 4 ثواني، اعمل slideUp (سحب لفوق واختفاء)
            window.setTimeout(function () {
                $(".alert").slideUp(600, function () {
                    $(this).remove(); // امسحها من الصفحة خالص بعد ما تختفي
                });
            }, 4000);


            $('#videoPreviewModal').on('hidden.bs.modal', function () {
                var videoPlayer = document.getElementById('previewVideoPlayer');

                if (videoPlayer) {
                    videoPlayer.pause();       // 1. وقف التشغيل
                    videoPlayer.currentTime = 0; // 2. رجعه للأول
                    videoPlayer.src = "";      // 3. فضي الرابط (عشان يوقف تحميل البيانات)
                    videoPlayer.load();        // 4. ريست للمشغل
                }
            });

        });


    </script>
}