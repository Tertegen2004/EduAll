@using EduAll.ViewModel
@model CoursesPage_vm

@{
    ViewData["Title"] = "All Courses";
    Layout = "_Layout";
}
<!-- ============================== Course Grid View Section Start ============================== -->

<section class="breadcrumb py-120 bg-main-25 position-relative z-1 overflow-hidden mb-0">
    <img src="/assets/images/shapes/shape1.png" alt="" class="shape one animation-rotation d-md-block d-none" />
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="breadcrumb__wrapper">
                    <h1 class="breadcrumb__title display-4 fw-semibold text-center">Courses</h1>
                    <ul class="breadcrumb__list d-flex align-items-center justify-content-center gap-4">
                        <li class="breadcrumb__item">
                            <a asp-controller="Home" asp-action="Index" class="breadcrumb__link text-neutral-500 hover-text-main-600 fw-medium">
                                <i class="text-lg d-inline-flex ph-bold ph-house"></i> Home
                            </a>
                        </li>
                        <li class="breadcrumb__item"><i class="text-neutral-500 d-flex ph-bold ph-caret-right"></i></li>
                        <li class="breadcrumb__item">
                            <span class="text-main-two-600">Courses</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="course-grid-view py-120">
    <div class="container">

        <div class="flex-between gap-16 flex-wrap mb-40">
            <span class="text-neutral-500">
                Showing @((Model.CurrentPage - 1) * 9 + 1) - @Math.Min(Model.CurrentPage * 9, Model.TotalCourses) of @Model.TotalCourses Results
            </span>

            <form method="get" asp-action="Index" class="flex-align gap-40 flex-wrap" id="filterForm">

                <div class="position-relative">
                    <input type="text" name="search" value="@Model.SearchQuery"
                           class="form-control rounded-pill py-8 px-16 border-neutral-30 bg-main-25"
                           placeholder="Search courses..." onchange="this.form.submit()">
                    <i class="ph ph-magnifying-glass position-absolute top-50 end-0 translate-middle-y me-20 text-neutral-500"></i>
                </div>

                <div class="flex-align gap-8">
                    <span class="text-neutral-500 flex-shrink-0">Sort By :</span>
                    <select name="sortBy" class="form-select ps-20 pe-28 py-8 fw-semibold rounded-pill bg-main-25 border border-neutral-30 text-neutral-700"
                            onchange="document.getElementById('filterForm').submit()">
                        <option value="Newest" selected="@(Model.SortBy == "Newest")">Newest</option>
                        <option value="Popular" selected="@(Model.SortBy == "Popular")">Popular</option>
                        <option value="Trending" selected="@(Model.SortBy == "Trending")">Trending</option>
                    </select>
                </div>
            </form>
        </div>

        <div class="row gy-4 mt-30 mb-30">
            @if (Model.Courses.Any())
            {
                @foreach (var course in Model.Courses)
                {
                    <div class="col-lg-4 col-sm-6 filter-item @course.CategoryFilter wow fadeInUp" data-aos="fade-up" data-aos-duration="200">
                        <div class="course-item bg-white rounded-16 p-12 h-100 box-shadow-md">
                            <div class="course-item__thumb rounded-12 overflow-hidden position-relative course-image-fixed-height">
                                <a asp-controller="Course" asp-action="Details" asp-route-id="@course.Id" class="w-100 h-100 d-block">
                                    <img src="@(string.IsNullOrEmpty(course.ImgUrl) ? "/assets/images/thumbs/course-img1.png" : course.ImgUrl)"
                                         alt="@course.Title" class="course-item__img rounded-12 cover-img transition-2 w-100 h-100" />
                                </a>

                                <div class="flex-align gap-8 bg-main-600 rounded-pill px-24 py-12 text-white position-absolute inset-block-start-0 inset-inline-start-0 mt-20 ms-20 z-1">
                                    <span class="text-2xl d-flex">
                                        <i class="ph ph-clock"></i>
                                    </span>
                                    <span class="text-lg fw-medium">@course.DurationHours H</span>
                                </div>

                                <button type="button"
                                        onclick="toggleWishlist(@course.Id, this)"
                                        class="w-48 h-48 flex-center position-absolute inset-block-start-0 inset-inline-end-0 mt-20 me-20 z-1 text-2xl rounded-circle transition-2
                                        @(course.IsWishlisted ? "bg-main-50 text-main-two-600" : "bg-white text-neutral-500 hover-text-main-two-600 hover-bg-main-50")">

                                    <i class="@(course.IsWishlisted ? "ph-fill" : "ph-bold") ph-heart"></i>

                                </button>
                            </div>

                            <div class="course-item__content position-relative">
                                <span class="course-item__user border border-white flex-center w-60 h-60 bg-white text-main-600 rounded-circle text-2xl transition-2">
                                    <img src="@(string.IsNullOrEmpty(course.InstructorImg) ? "/assets/images/thumbs/user-two-img1.png" : course.InstructorImg)"
                                         alt="" class="w-100 h-100 object-fit-cover rounded-circle" />
                                </span>

                                <div class="mb-16 flex-align gap-16 flex-wrap">
                                    <span class="py-4 px-12 rounded-pill text-main-600 fw-medium bg-main-25 text-sm">
                                        @course.CategoryName
                                    </span>
                                    <span class="py-4 px-12 rounded-pill text-main-three-600 fw-medium bg-main-three-25 text-sm">
                                        @(string.IsNullOrEmpty(course.Level) ? "Beginner" : course.Level)
                                    </span>
                                </div>

                                <h4 class="mb-16">
                                    <a asp-controller="Course" asp-action="Details" asp-route-id="@course.Id" class="link text-line-2">@course.Title</a>
                                </h4>

                                <div class="flex-align gap-28 flex-wrap mb-16">
                                    <div class="flex-align gap-8">
                                        <span class="text-neutral-700 text-lg d-flex"><i class="ph-bold ph-video-camera"></i></span>
                                        <span class="text-neutral-700 text-sm fw-medium">@course.LessonsCount Lessons</span>
                                    </div>

                                    <div class="flex-align gap-8">
                                        <span class="text-neutral-700 text-lg d-flex"><i class="ph-bold ph-users"></i></span>
                                        <span class="text-neutral-700 text-sm fw-medium">@course.StudentsCount Students</span>
                                    </div>
                                    <div class="flex-align gap-4">
                                        <span class="text-2xl fw-medium text-warning-600 d-flex"><i class="ph-fill ph-star"></i></span>
                                        <span class="text-lg text-neutral-700 fw-medium">4.8</span>
                                    </div>
                                </div>
                                <div class="flex-between gap-8 pt-24 border-top border-neutral-50 mt-28 border-dashed border-0">
                                    <h4 class="mb-0 text-main-two-600">$@course.Price</h4>

                                    @if (course.IsEnrolled)
                                    {
                                        <a asp-controller="MyCourses" asp-action="Index"
                                           class="flex-align gap-8 text-success-600 transition-1 fw-semibold">
                                            Owned <i class="ph-bold ph-check-circle"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <button type="button"
                                                onclick="addToCart(@course.Id, this)"
                                                class="flex-align gap-8 text-main-600 transition-1 fw-semibold bg-transparent border-0 p-0">
                                            Add To Cart
                                            <i class="ph ph-arrow-right"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-center py-5">
                    <div class="w-80 h-80 bg-gray-50 rounded-circle flex-center mx-auto text-gray-400 text-4xl mb-16">
                        <i class="ph ph-magnifying-glass"></i>
                    </div>
                    <h5 class="text-neutral-500">No courses found matching your criteria.</h5>
                    <a asp-action="Index" class="btn btn-outline-main rounded-pill mt-3">Clear Filters</a>
                </div>
            }
        </div>

        @if (Model.TotalPages > 1)
        {
            <ul class="pagination mt-50 flex-align gap-12 flex-wrap justify-content-center">

                <li class="page-item @(!Model.HasPrevious ? "disabled" : "")">
                    <a class="page-link text-neutral-700 fw-semibold w-40 h-40 bg-main-25 rounded-circle hover-bg-main-600 border-neutral-30 hover-border-main-600 hover-text-white flex-center p-0"
                       asp-action="Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-search="@Model.SearchQuery" asp-route-sortBy="@Model.SortBy">
                        <i class="ph-bold ph-caret-left"></i>
                    </a>
                </li>

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item">
                        <a class="page-link fw-semibold w-40 h-40 rounded-circle flex-center p-0 transition-1
                                  @(i == Model.CurrentPage ? "bg-main-600 text-white border-main-600" : "bg-main-25 text-neutral-700 border-neutral-30 hover-bg-main-600 hover-text-white")"
                           asp-action="Index" asp-route-page="@i" asp-route-search="@Model.SearchQuery" asp-route-sortBy="@Model.SortBy">
                            @i
                        </a>
                    </li>
                }

                <li class="page-item @(!Model.HasNext ? "disabled" : "")">
                    <a class="page-link text-neutral-700 fw-semibold w-40 h-40 bg-main-25 rounded-circle hover-bg-main-600 border-neutral-30 hover-border-main-600 hover-text-white flex-center p-0"
                       asp-action="Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-search="@Model.SearchQuery" asp-route-sortBy="@Model.SortBy">
                        <i class="ph-bold ph-caret-right"></i>
                    </a>
                </li>
            </ul>
        }

    </div>
</section>
<!-- ============================== Course Grid View Section End ============================== -->
<!-- ================================= Certificate Section Start ================================= -->
<div class="certificate">
    <div class="container container--lg">
        <div class="certificate-box px-16 bg-main-600 rounded-16">
            <div class="container">
                <div class="position-relative py-80">
                    <div class="row align-items-center">
                        <div class="col-xl-6">
                            <div class="certificate__content">
                                <div class="flex-align gap-8 mb-16 wow bounceInDown">
                                    <span class="w-8 h-8 bg-white rounded-circle"></span>
                                    <h5 class="text-white mb-0">Get Certificate</h5>
                                </div>
                                <h2 class="text-white mb-40 fw-medium wow bounceIn">
                                    Get Quality Skills Certificate From the EduAll
                                </h2>
                                <a href=""
                                   class="btn btn-white rounded-pill flex-align d-inline-flex gap-8 hover-bg-main-800 wow bounceInUp">
                                    Get Started Now
                                    <i class="ph-bold ph-arrow-up-right d-flex text-lg"></i>
                                </a>
                            </div>
                        </div>
                        <div class="col-xl-6 d-xl-block d-none">
                            <div class="certificate__thumb" data-aos="fade-up-left">
                                <img src="/assets/images/thumbs/certificate-img.png"
                                     alt=""
                                     data-tilt
                                     data-tilt-max="8"
                                     data-tilt-speed="500"
                                     data-tilt-perspective="5000"
                                     data-tilt-full-page-listening />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ================================= Certificate Section End ================================= -->
@section Scripts {
    <script>

        function toggleWishlist(courseId, btnElement) {
            $.ajax({
                url: '/Wishlist/Toggle',
                type: 'POST',
                data: { courseId: courseId },
                success: function (response) {
                    if (response.success) {
                        var icon = $(btnElement).find('i');

                        // 1. الإمساك بعنصر العداد (اللي في الهيدر)
                        var countBadge = $("#wishlist-count");
                        var currentCount = parseInt(countBadge.text()); // قراءة الرقم الحالي

                        if (response.isAdded) {
                            // === حالة الإضافة ===
                            $(btnElement).addClass('bg-main-50 text-main-two-600').removeClass('bg-white text-neutral-500');
                            icon.removeClass('ph ph-bold').addClass('ph-fill');

                            // زيادة العداد
                            countBadge.text(currentCount + 1);

                            // (اختياري) تأثير انيميشن بسيط للعداد
                            countBadge.addClass("animate__bounceIn").one("animationend", function () {
                                $(this).removeClass("animate__bounceIn");
                            });

                        } else {
                            // === حالة الحذف ===
                            $(btnElement).removeClass('bg-main-50 text-main-two-600').addClass('bg-white text-neutral-500');
                            icon.removeClass('ph-fill').addClass('ph-bold');

                            // تنقيص العداد
                            if (currentCount > 0) countBadge.text(currentCount - 1);
                        }
                    } else {
                        window.location.href = '/Admin/Account/SignIn';
                    }
                },
                error: function () {
                    // handle error
                }
            });
        }
        function addToCart(courseId, btnElement) {
            // نغير النص لـ "Adding..." عشان اليوزر يعرف إن فيه حاجة بتحصل
            var originalText = $(btnElement).html();
            $(btnElement).html('<i class="ph ph-spinner ph-spin"></i> Adding...');

            $.ajax({
                url: '/Cart/Add',
                type: 'POST',
                data: { courseId: courseId },
                success: function (response) {
                    if (response.success) {
                        // 1. تحديث العداد في الهيدر
                        $('#cart-count-badge').text(response.cartCount);

                        // 2. تغيير شكل الزرار ليدل على النجاح
                        $(btnElement).html('Added <i class="ph-bold ph-check"></i>');
                        $(btnElement).addClass('text-success-600 cursor-default').attr('onclick', ''); // نلغي الضغط تاني

                        // (اختياري) رسالة توستر
                        // toastr.success(response.message);
                    } else {
                        // لو فشل (مثلاً موجود قبل كدا)
                        if (response.message === "Login required") {
                            window.location.href = '/Admin/Account/SignIn';
                        } else {
                            // نرجع الزرار زي ما كان ونطلع رسالة
                            $(btnElement).html(originalText);
                            alert(response.message); // أو toastr.warning
                        }
                    }
                },
                error: function () {
                    $(btnElement).html(originalText);
                    alert("Something went wrong");
                }
            });
        }

         
    </script>
}
